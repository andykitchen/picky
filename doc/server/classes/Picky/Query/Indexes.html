<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Picky::Query::Indexes</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/github.css" type="text/css" media="screen" />
<script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            Picky::Query::Indexes 
            
                <span class="parent">&lt; 
                    
                    <a href="../../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/picky/query/indexes_rb.html">lib/picky/query/indexes.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>The query indexes class bundles indexes given to a query.</p>

<p>Example:</p>

<pre># If you call
Search.new dvd_index, mp3_index, video_index

# What it does is take the three given (API-) indexes and
# bundle them in an index bundle.</pre>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-allocation_for">allocation_for</a>,
              </li>
            
              
              <li>
                <a href="#method-i-allocations_ary_for">allocations_ary_for</a>,
              </li>
            
              
              <li>
                <a href="#method-i-allocations_for">allocations_for</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-expand_combinations_from">expand_combinations_from</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-ignore">ignore</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-only">only</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-prepared_allocations_for">prepared_allocations_for</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    
      <!-- Section attributes -->
      <div class="sectiontitle">Attributes</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>ignored_categories</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>indexes</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <a name="method-c-new"></a><b>new</b>(*indexes)
            
          </div>
          
          
            <div class="description">
              <p>Creates a new <a href="Indexes.html">Query::Indexes</a>.</p>

<p>Its job is to generate all possible combinations. Note: We cannot mix
memory and redis indexes just yet.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 30</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">initialize</span> *<span class="ruby-identifier">indexes</span>
  <span class="ruby-constant">IndexesCheck</span>.<span class="ruby-identifier">check_backends</span> <span class="ruby-identifier">indexes</span>

  <span class="ruby-ivar">@indexes</span> = <span class="ruby-identifier">indexes</span>
  
  <span class="ruby-ivar">@mapper</span> = <span class="ruby-constant">QualifierCategoryMapper</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">indexes</span> <span class="ruby-comment"># TODO Move out?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                  
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-allocation_for">
            
              <a name="method-i-allocation_for"></a><b>allocation_for</b>(tokens, index)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-allocation_for_source')" id="l_method-i-allocation_for_source">show</a>
                
              </p>
              <div id="method-i-allocation_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 108</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">allocation_for</span> <span class="ruby-identifier">tokens</span>, <span class="ruby-identifier">index</span>
  <span class="ruby-comment"># Expand the combinations.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">possible_combinations</span> = <span class="ruby-identifier">tokens</span>.<span class="ruby-identifier">possible_combinations_in</span> <span class="ruby-identifier">index</span>

  <span class="ruby-comment"># Generate all possible combinations.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">all_possible_combinations</span> = <span class="ruby-identifier">expand_combinations_from</span> <span class="ruby-identifier">possible_combinations</span>

  <span class="ruby-comment"># Add the wrapped possible allocations to the ones we already have.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">all_possible_combinations</span>.<span class="ruby-identifier">map!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">expanded_combinations</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Allocation</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">index</span>, <span class="ruby-constant">Query</span><span class="ruby-operator">::</span><span class="ruby-constant">Combinations</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">expanded_combinations</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-allocations_ary_for">
            
              <a name="method-i-allocations_ary_for"></a><b>allocations_ary_for</b>(tokens)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-allocations_ary_for_source')" id="l_method-i-allocations_ary_for_source">show</a>
                
              </p>
              <div id="method-i-allocations_ary_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 103</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">allocations_ary_for</span> <span class="ruby-identifier">tokens</span>
  <span class="ruby-identifier">indexes</span>.<span class="ruby-identifier">inject</span>([]) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">allocations</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">allocations</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">allocation_for</span>(<span class="ruby-identifier">tokens</span>, <span class="ruby-identifier">index</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-allocations_for">
            
              <a name="method-i-allocations_for"></a><b>allocations_for</b>(tokens)
            
          </div>
          
          
            <div class="description">
              <p>Returns a number of possible allocations for the given tokens.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-allocations_for_source')" id="l_method-i-allocations_for_source">show</a>
                
              </p>
              <div id="method-i-allocations_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 98</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">allocations_for</span> <span class="ruby-identifier">tokens</span>
  <span class="ruby-identifier">tokens</span>.<span class="ruby-identifier">categorize</span> <span class="ruby-ivar">@mapper</span>

  <span class="ruby-constant">Allocations</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">allocations_ary_for</span>(<span class="ruby-identifier">tokens</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-expand_combinations_from">
            
              <a name="method-i-expand_combinations_from"></a><b>expand_combinations_from</b>(possible_combinations)
            
          </div>
          
          
            <div class="description">
              <p>This is the core of the search engine. No kidding.</p>

<p>Gets an array of [</p>

<pre>[&lt;combinations for token1&gt;],
[&lt;combinations for token2&gt;],
[&lt;combinations for token3&gt;]</pre>

<p>]</p>

<p>Generates all possible allocations of combinations. [</p>

<pre>[first combination of token1, first c of t2, first c of t3],
[first combination of token1, first c of t2, second c of t3]
...</pre>

<p>]</p>

<p>Generates all possible combinations of array elements:</p>
<dl class="rdoc-list label-list"><dt>1,2,3
<dd>
<p>x [a,b,c] x [k,l,m] =&gt; [[1,a,k], [1,a,l], [1,a,m], [1,b,k], [1,b,l],
[1,b,m], [1,c,k], …, [3,c,m]]</p>
</dd></dl>

<p>Note: Also calculates the weights and sorts them accordingly.</p>

<p>Note: This is a heavily optimized ruby version.</p>

<p>Works like this:</p>
<dl class="rdoc-list label-list"><dt>1,2,3], [a,b,c], [k,l,m
<dd>
<p>are expanded to</p>
</dd></dl>

<pre>group mult: 1
&lt;- single mult -&gt;</pre>
<dl class="rdoc-list label-list"><dt>1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3
<dd>
<h1 id="method-i-expand_combinations_from-label-27+elements">27 elements</h1>
</dd></dl>

<pre>group mult: 3
&lt;- -&gt; s/m</pre>
<dl class="rdoc-list label-list"><dt>a,a,a,b,b,b,c,c,c,a,a,a,b,b,b,c,c,c,a,a,a,b,b,b,c,c,c
<dd>
<h1 id="method-i-expand_combinations_from-label-27+elements">27 elements</h1>
</dd></dl>

<pre>group mult: 9
&lt;&gt; s/m</pre>
<dl class="rdoc-list label-list"><dt>k,l,m,k,l,m,k,l,m,k,l,m,k,l,m,k,l,m,k,l,m,k,l,m,k,l,m
<dd>
<h1 id="method-i-expand_combinations_from-label-27+elements">27 elements</h1>
</dd></dl>

<p>It is then recombined, where [</p>

<pre>[a,a,b,b,c,c]
[d,e,d,e,d,e]</pre>

<p>] becomes [</p>

<pre>[a,d],
[a,e],
[b,d],
[b,e],
[c,d],
[c,e]</pre>

<p>]</p>

<p>Note: Not using transpose as it is slower.</p>

<p>Returns nil if there are no combinations.</p>

<p>Note: Of course I could split this method up into smaller</p>

<pre>ones, but I guess I am a bit sentimental.</pre>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-expand_combinations_from_source')" id="l_method-i-expand_combinations_from_source">show</a>
                
              </p>
              <div id="method-i-expand_combinations_from_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 180</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">expand_combinations_from</span> <span class="ruby-identifier">possible_combinations</span>
  <span class="ruby-comment"># If an element has size 0, this means one of the</span>
  <span class="ruby-comment"># tokens could not be allocated.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">possible_combinations</span>.<span class="ruby-identifier">any?</span>(&amp;<span class="ruby-value">:empty?</span>)

  <span class="ruby-comment"># Generate the first multiplicator &quot;with which&quot; (well, not quite) to multiply the smallest amount of combinations.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">single_mult</span> = <span class="ruby-identifier">possible_combinations</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-number">1</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">total</span>, <span class="ruby-identifier">combinations</span><span class="ruby-operator">|</span> <span class="ruby-identifier">total</span> * <span class="ruby-identifier">combinations</span>.<span class="ruby-identifier">size</span> }

  <span class="ruby-comment"># Initialize a group multiplicator.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">group_mult</span> = <span class="ruby-number">1</span>

  <span class="ruby-comment"># The expanding part to line up the combinations</span>
  <span class="ruby-comment"># for later combination in allocations.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">possible_combinations</span>.<span class="ruby-identifier">collect!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">combinations</span><span class="ruby-operator">|</span>

    <span class="ruby-comment"># Get the size of the combinations of the first token.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">combinations_size</span> = <span class="ruby-identifier">combinations</span>.<span class="ruby-identifier">size</span>

    <span class="ruby-comment"># Special case: If there is no combination for one of the tokens.</span>
    <span class="ruby-comment">#               In that case, we just use the same single mult for</span>
    <span class="ruby-comment">#               the next iteration.</span>
    <span class="ruby-comment">#               If there are combinations, we divide the single mult</span>
    <span class="ruby-comment">#               by the number of combinations.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">single_mult</span> <span class="ruby-operator">/=</span> <span class="ruby-identifier">combinations_size</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">combinations_size</span>.<span class="ruby-identifier">zero?</span>

    <span class="ruby-comment"># Expand each combination by the single mult:</span>
    <span class="ruby-comment"># [a,b,c]</span>
    <span class="ruby-comment"># [a,a,a,  b,b,b,  c,c,c]</span>
    <span class="ruby-comment"># Then, expand the result by the group mult:</span>
    <span class="ruby-comment"># [a,a,a,b,b,b,c,c,c,  a,a,a,b,b,b,c,c,c,  a,a,a,b,b,b,c,c,c]</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">combinations</span> = <span class="ruby-identifier">combinations</span>.<span class="ruby-identifier">inject</span>([]) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">total</span>, <span class="ruby-identifier">combination</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">total</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">single_mult</span>, <span class="ruby-identifier">combination</span>)
    <span class="ruby-keyword">end</span> * <span class="ruby-identifier">group_mult</span>

    <span class="ruby-comment"># Multiply the group mult by the combinations size,</span>
    <span class="ruby-comment"># since the next combinations' single mult is smaller</span>
    <span class="ruby-comment"># and we need to adjust for that.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">group_mult</span> = <span class="ruby-identifier">group_mult</span> * <span class="ruby-identifier">combinations_size</span>

    <span class="ruby-comment"># Return the combinations.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">combinations</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">possible_combinations</span>.<span class="ruby-identifier">empty?</span>

  <span class="ruby-identifier">possible_combinations</span>.<span class="ruby-identifier">shift</span>.<span class="ruby-identifier">zip</span> *<span class="ruby-identifier">possible_combinations</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-ignore">
            
              <a name="method-i-ignore"></a><b>ignore</b>(*qualifiers)
            
          </div>
          
          
            <div class="description">
              <p>Ignore the categories with these qualifiers.</p>

<p>Example:</p>

<pre>search = Search.new(index1, index2, index3) do
  ignore :name, :first_name
end</pre>

<p>Cleans up / optimizes after being called.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-ignore_source')" id="l_method-i-ignore_source">show</a>
                
              </p>
              <div id="method-i-ignore_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 47</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">ignore</span> *<span class="ruby-identifier">qualifiers</span>
  <span class="ruby-ivar">@ignored_categories</span> <span class="ruby-operator">||=</span> []
  <span class="ruby-ivar">@ignored_categories</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">qualifiers</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">qualifier</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@mapper</span>.<span class="ruby-identifier">map</span> <span class="ruby-identifier">qualifier</span> }.<span class="ruby-identifier">compact</span>
  <span class="ruby-ivar">@ignored_categories</span>.<span class="ruby-identifier">uniq!</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-only">
            
              <a name="method-i-only"></a><b>only</b>(*qualifiers)
            
          </div>
          
          
            <div class="description">
              <p>Restrict categories to the given ones.</p>

<p>Functionally equivalent as if indexes didn’t have the categories at all.</p>

<p>Note: Probably only makes sense when an index is used in multiple searches.
If not, why even have the categories?</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-only_source')" id="l_method-i-only_source">show</a>
                
              </p>
              <div id="method-i-only_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 62</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">only</span> *<span class="ruby-identifier">qualifiers</span>
  <span class="ruby-ivar">@mapper</span>.<span class="ruby-identifier">restrict_to</span> *<span class="ruby-identifier">qualifiers</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-prepared_allocations_for">
            
              <a name="method-i-prepared_allocations_for"></a><b>prepared_allocations_for</b>(tokens, weights = {})
            
          </div>
          
          
            <div class="description">
              <p>Returns a number of prepared (sorted, reduced etc.) allocations for the
given tokens.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-prepared_allocations_for_source')" id="l_method-i-prepared_allocations_for_source">show</a>
                
              </p>
              <div id="method-i-prepared_allocations_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/picky/query/indexes.rb, line 68</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">prepared_allocations_for</span> <span class="ruby-identifier">tokens</span>, <span class="ruby-identifier">weights</span> = {}, <span class="ruby-identifier">amount</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">allocations</span> = <span class="ruby-identifier">allocations_for</span> <span class="ruby-identifier">tokens</span>

  <span class="ruby-comment"># Removed: Remove potential double allocations.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Note: allocations are unique by definition.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># allocations.uniq! unless tokens.uniq?</span>

  <span class="ruby-comment"># Score the allocations using weights as bias.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">allocations</span>.<span class="ruby-identifier">calculate_score</span> <span class="ruby-identifier">weights</span>

  <span class="ruby-comment"># Sort the allocations.</span>
  <span class="ruby-comment"># (allocations are sorted according to score, highest to lowest)</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">allocations</span>.<span class="ruby-identifier">sort!</span>

  <span class="ruby-comment"># Reduce the amount of allocations.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">allocations</span>.<span class="ruby-identifier">reduce_to</span> <span class="ruby-identifier">amount</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">amount</span>

  <span class="ruby-comment"># Remove categories from allocations.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">allocations</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">ignored_categories</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ignored_categories</span>

  <span class="ruby-identifier">allocations</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>
    </div>
  </body>
</html>    